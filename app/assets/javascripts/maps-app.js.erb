var map = '';

function initialize_map(){
  L.mapbox.accessToken = "<%= MAPBOX['token'] %>";
  function detectPosition(){
    if (typeof navigator.geolocation == 'object'){
      navigator.geolocation.getCurrentPosition(setMyPosition);
    }else{
      alert("your browser don't support geolocation, please select your position");
      map = L.mapbox.map('map', 'sarriagada.j4p9400k');
      return map;
    }
  }

  function setMyPosition(p){
    map = L.mapbox.map('map', 'sarriagada.j4p9400k').setView([p.coords.latitude, p.coords.longitude], 15);
    getEvents();
    return map;
  }
  detectPosition();
}

function setLocation(location){
  var geocoder = L.mapbox.geocoder('mapbox.places-v1');
  geocoder.query(location, showMap);
}

function showMap(err, data){
  if (data.lbounds) {
      map.fitBounds(data.lbounds);
  } else if (data.latlng) {
      map.setView([data.latlng[0], data.latlng[1]], 15);
  }
}

function getEvents(params){
  console.log(1);
  var url = 'http://localhost:3000/api/events';
  console.log(2);
  $.getJSON( url, function( data ) {
    console.log(3);
    console.log(data);
    map.featureLayer.setGeoJSON(data);
    console.log(4);
  });
}